<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.120.4"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Case 09 ‚Üí Taken ‚òéÔ∏è&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>Case 09 ‚Üí Taken ‚òéÔ∏è</h1><p class=article-date>2023-10-18</p></section><article class=markdown-body><p><strong>Background</strong>:¬†<strong>Krypto kidnapped none other than Professor Smoke himself!</strong></p><p><strong>Mission: Use the graph-matching tool to figure out if an attack on the KDA network happened.</strong></p><p><strong>For all the marbles: What machine was compromised.</strong></p><hr><p><a href=https://learn.microsoft.com/en-us/azure/data-explorer/graph-overview target=_blank>Graphs!</a> and schnitzels.. at the end.. maybe?</p><p><strong>What we know</strong></p><ul><li>All requests to the KDA network flow through: Gateway machine before taking a journey through various Backends until they finally reach the Admin.</li><li>Requests get split to sub-tasks executed on the BE or Admin.</li><li>Each machine undergoes periodic vulnerability scans.</li></ul><p><strong>Treasure hunt</strong></p><p>Find a request or any of its sub-tasks that reached a vulnerable Admin machine, with the Gateway and Backends also being vulnerable.</p><p><strong>Into the woods!</strong></p><p>Let us analyze our data first and prepare it before graphing.</p><pre tabindex=0><code class=language-markup data-lang=markup>MachineLogs
| take 50

MachineLogs
| distinct EventType

**# -- EventType -- #**
# IncomingRequest
# SpawnTask
# PeriodicScan
</code></pre><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/09_1.png><img class=img src=/images/kusto/09_1.png alt></a></p><ol><li>Find the machines that were found to have vulnerabilities during the scans:</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kd>let</span> <span class=nx>VulnMachines</span> <span class=o>=</span> <span class=nx>MachineLogs</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>where</span> <span class=nx>EventType</span> <span class=o>==</span> <span class=s2>&#34;PeriodicScan&#34;</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>parse</span> <span class=nx>Message</span> <span class=kd>with</span> <span class=nx>MachineType</span><span class=o>:</span><span class=nx>string</span> <span class=s2>&#34; periodic scan completed, &#34;</span> <span class=nx>VulnCount</span><span class=o>:</span><span class=kr>long</span> <span class=o>*</span> 
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>where</span> <span class=nx>VulnCount</span> <span class=o>&gt;</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>distinct</span> <span class=nx>Machine</span><span class=p>,</span> <span class=nx>MachineType</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>take</span> <span class=mi>100</span>
</span></span></code></pre></div><ol><li>Let‚Äôs figure the vulnerable machines that received requests and grab task IDs.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kd>let</span> <span class=nx>HotMachines</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=nx>MachineLogs</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>where</span> <span class=nx>EventType</span> <span class=o>==</span> <span class=s2>&#34;IncomingRequest&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>lookup</span> <span class=nx>kind</span><span class=o>=</span><span class=nx>inner</span> <span class=nx>VulnMachines</span> <span class=nx>on</span> <span class=nx>Machine</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>parse</span>  <span class=nx>Message</span> <span class=kd>with</span>  <span class=o>*</span> <span class=s2>&#34;TaskID=&#34;</span> <span class=nx>TaskID</span><span class=o>:</span><span class=nx>guid</span> <span class=o>*</span><span class=p>;</span>
</span></span></code></pre></div><ol><li>Let‚Äôs figure the vulnerable machines that spawned request tasks to other machines and grab child machine and child task IDs.</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kd>let</span> <span class=nx>Spawners</span> <span class=o>=</span> 
</span></span><span class=line><span class=cl>    <span class=nx>MachineLogs</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>where</span> <span class=nx>EventType</span> <span class=o>==</span> <span class=s2>&#34;SpawnTask&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>lookup</span> <span class=nx>kind</span><span class=o>=</span><span class=nx>inner</span> <span class=nx>VulnMachines</span> <span class=nx>on</span> <span class=nx>Machine</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>parse</span>  <span class=nx>Message</span> <span class=kd>with</span>  <span class=o>*</span> <span class=s2>&#34;TaskID=&#34;</span> <span class=nx>TaskID</span><span class=o>:</span><span class=nx>guid</span> <span class=o>*</span> <span class=s2>&#34;TaskID=&#34;</span> <span class=nx>ChildTaskID</span><span class=o>:</span><span class=nx>guid</span> <span class=o>*</span> <span class=s2>&#34;on &#34;</span> <span class=nx>ChildMachine</span><span class=p>;</span>
</span></span></code></pre></div><p>What we have. From identifying all the vulnerable machines, we divided into a set that received requested and a set that spawned requested and to which machines.</p><p>Now, we need to find a request that passed from through a chain of vulnerable machines (from a gateway machine to an admin machine).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>Spawners</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>make</span><span class=o>-</span><span class=nx>graph</span> <span class=nx>TaskID</span><span class=o>--&gt;</span><span class=nx>ChildTaskID</span> <span class=kd>with</span> <span class=nx>HotMachines</span> <span class=nx>on</span> <span class=nx>TaskID</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>graph</span><span class=o>-</span><span class=nx>match</span> <span class=p>(</span><span class=nx>gateway</span><span class=p>)</span><span class=o>-</span><span class=p>[</span><span class=nx>backend</span><span class=o>*</span><span class=mf>1..25</span><span class=p>]</span><span class=o>-&gt;</span><span class=p>(</span><span class=nx>admin</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nx>where</span> <span class=nx>gateway</span><span class=p>.</span><span class=nx>MachineType</span> <span class=o>==</span> <span class=s2>&#34;Gateway&#34;</span> <span class=nx>and</span> <span class=nx>target</span><span class=p>.</span><span class=nx>MachineType</span> <span class=o>==</span> <span class=s2>&#34;Admin&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nx>project</span> <span class=nx>Start</span><span class=o>=</span><span class=nx>gateway</span><span class=p>.</span><span class=nx>Machine</span><span class=p>,</span> <span class=nx>End</span><span class=o>=</span><span class=nx>admin</span><span class=p>.</span><span class=nx>Machine</span><span class=p>,</span> <span class=nx>path</span><span class=o>=</span><span class=nx>backend</span><span class=p>.</span><span class=nx>Machine</span>
</span></span></code></pre></div><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/09_2.png><img class=img src=/images/kusto/09_2.png alt></a></p><hr><aside>üí° This challenge sent me on rabbit holes while attempting to prepare the data for graphing. Major thanks to hints from [Liesel Hughes](https://www.lieselhughes.com/posts/tech/kusto-detective-agency/season2case9/) that streamlined my thought process.</aside></article><section class=article-labels><a class="article-category li" href=/categories/kusto-detective-agency/><span class=hashtag>#</span>Kusto Detective Agency</a><a class="article-tag li" href=/tags/kql/><span class=hashtag>#</span>kql</a></section><section class=article-navigation><p><a class=link href=/posts/its_on_fire/><span class=li></span>It's On Fire! üî•</a></p><p><a class=link href=/posts/magic_trick/><span class=li></span>SHCTF23: Magic Trick</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>¬© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>