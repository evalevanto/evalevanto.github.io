<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>MicroCorruption: Santa Cruz&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>MicroCorruption: Santa Cruz</h1><p class=article-date>2020-11-04</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/cruz.jpg><img class=img src=/images/microcorruption/cruz/cruz.jpg alt></a></p><p>Nice! Here is a lock. This is the manual:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-details.png><img class=img src=/images/microcorruption/cruz/santa-details.png alt></a></p><ul><li>Passwords that are <strong>too long are rejected</strong>.</li></ul><p>There is not much clues from the manual.</p><p>The <code>main</code> function just calls the <code>login</code> function:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-login.png><img class=img src=/images/microcorruption/cruz/santa-login.png alt></a></p><ul><li><p>Authentication requires a username and password input. The prompt states that these inputs should be between 8 and 16 chars. :D</p></li><li><p>Bytes <code>0x0, 0x8 and 0x10</code> are set into the addresses at <code>r4 - (0x6, 0x19,0x18)</code> respectively. This will probably make sense soon.</p></li><li><p>The <code>getsn</code> function for getting the username:</p><ul><li><strong>length</strong> of input buffer: held at <code>r14</code> -> <code>0x63(99)</code> characters. :D</li><li><strong>address</strong> to the input buffer: held at <code>r15</code> -> <code>0x2404</code>.</li></ul></li><li><p>Call to <code>strcpy()</code> for username input to address <code>0x43a2</code>(this gets evident while running the program.)</p></li><li><p>The <code>getsn</code> function for getting the password:</p><ul><li><strong>length</strong> of input buffer: held at <code>r14</code> -> <code>0x63(99)</code> characters.</li><li><strong>address</strong> to the input buffer: held at <code>r15</code> -> <code>0x2404</code>.</li></ul></li><li><p>Call to <code>strcpy()</code> for username input to address <code>0x43b5</code>(this gets evident while running the program.)</p></li></ul><blockquote><p>The address where the password input is copied to by the <code>strcpy()</code> is interesting. It is only <code>0x43b5 - 0x43a2 = 0x13(19)</code> bytes apart.</p><p>What this means is: for a username input > 19, <strong>the extra bytes get overriden by the password copy</strong>. This aaalso means that it is <strong>possible to write well beyond the password content copy</strong> if there&rsquo;s is any constraint on the password input buffer. <strong>:D</strong></p><p>Smells and definitely quacks like a clue!!</p></blockquote><p>You run a test run to get a feel on the program. Since the provisioned length of the input buffer is greater than the prompted one:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-test-user.png><img class=img src=/images/microcorruption/cruz/santa-test-user.png alt></a></p><p>The program proceeds&mldr;</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-login-jnc.png><img class=img src=/images/microcorruption/cruz/santa-login-jnc.png alt></a></p><blockquote><p>there is a <code>cmp</code>operation done between the length of the copied username input and the value at <code>r4(0x43cc) - 0x18 = 0x43b4</code>: this was originally set to <code>0x10</code>.</p><p>This value gets overwritten by the <strong><code>19th</code> username input byte</strong>: <code>0x61</code>(remember that the <code>strcpy</code> dest address for username input is <code>0x43a2</code> from earlier).</p><p>Since <code>r15(0x61) > r11(0x18)</code>, no carry flag is set.(For more on this, refer to previous <a href=https://evalevanto.github.io/blog/microcorruption-jakarta/ target=_blank>notes</a>. The program continues.</p></blockquote><ul><li>there is another <code>cmp</code> operation between length of copied username input and value at <code>r4(0x43cc) - 0x19 = 0x43b3</code>: this was originally set to <code>0x8</code>. This value is now <code>0x61</code>(the <strong>18th byte of username input</strong>).<ul><li>The program advances only when the carry flag is set. This means, <code>r15</code> value has to be less than <code>r11</code>.</li><li>The <code>18th</code> byte of the username has to be less than the length!</li></ul></li></ul><p>You run a test to bypass this:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-username.png><img class=img src=/images/microcorruption/cruz/santa-username.png alt></a></p><p>The authentication check fails, but the program proceeds:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-proc.png><img class=img src=/images/microcorruption/cruz/santa-proc.png alt></a></p><blockquote><p>Can the return address be modified?</p></blockquote><ul><li>Probably, but first, there is a <code>tst.b</code> that happens before.<ul><li>The byte at address <code>-0x6(r4) = 0x43c6</code> has to be zero for the program to proceed to fetch the return address to jump to.</li><li>This byte being checked is the <code>18th</code> byte of the password input. You can have the password terminate with zero byte on the 18th byte.</li></ul></li></ul><p>You rerun a test with these steps:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-sp-2.png><img class=img src=/images/microcorruption/cruz/santa-sp-2.png alt></a></p><ul><li><p>The return address is at <code>0x43c8</code>. If you can find a way to modify this, you can jump to the call to <code>unlock_door</code> at address <code>0x463a</code>.</p><ul><li><ol><li>Cannot use password input for this; because of <code>strcpy()</code>. The zero byte will terminate the copy and the bytes after will not be copied.</li></ol></li></ul><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-strcpy.jpg><img class=img src=/images/microcorruption/cruz/santa-strcpy.jpg alt></a></p><ul><li><ol start=2><li>You can use the username input for this. If you recall from earlier: <em>it is possible to write well beyond the password content copy</em> and <em>the extra bytes get overriden by the password copy</em>.</li></ol></li></ul><blockquote><p>Basically, have a username input extend enough to modify the return value.</p></blockquote></li></ul><p>You give this a try with the following input:</p><p>username:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-corr-user.png><img class=img src=/images/microcorruption/cruz/santa-corr-user.png alt></a>
<a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-set-addr.png><img class=img src=/images/microcorruption/cruz/santa-set-addr.png alt></a></p><p>password:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-corr-pass.png><img class=img src=/images/microcorruption/cruz/santa-corr-pass.png alt></a></p><p>This is what you observe:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-flags.png><img class=img src=/images/microcorruption/cruz/santa-flags.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cruz/santa-sp-point.png><img class=img src=/images/microcorruption/cruz/santa-sp-point.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/door-unlocked.png><img class=img src=/images/microcorruption/door-unlocked.png alt></a></p><blockquote><p>Another one down!</p><p>Onwards and Algiers. _0/</p></blockquote></article><section class=article-labels><a class="article-category li" href=/categories/reverse-engineering/><span class=hashtag>#</span>Reverse Engineering</a><a class="article-category li" href=/categories/micro-corruption/><span class=hashtag>#</span>Micro Corruption</a><a class="article-tag li" href=/tags/buffer-overflow/><span class=hashtag>#</span>buffer overflow</a></section><section class=article-navigation><p><a class=link href=/posts/microcorruption-jakarta/><span class=li></span>MicroCorruption: Jakarta</a></p><p><a class=link href=/posts/microcorruption-novo/><span class=li></span>MicroCorruption: Novosibirsk</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>