<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.121.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>SHCTF23: Veiled Dimensions&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>SHCTF23: Veiled Dimensions</h1><p class=article-date>2023-09-25</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/veils/00.png><img class=img src=/images/veils/00.png alt=Untitled></a></p><p><strong>Description: Dive deep into the virtual realm and remember, duality hides the truth. Seek where they intertwine, and the solution will emerge.</strong></p><hr><h2 id=unintended-path><strong>Unintended Path</strong></h2><p>Fire up the program in gdb: <code>gdb -q ./dim</code></p><p>Disassemble <code>main</code> . There are 3 calls to <code>puts</code> right before an <code>exit()</code> .You find an interesting one and from <code>objdump -sj .rodata dim</code> , you learn that this is the fail case prompt: ‚ÄúIncorrect key!‚Äù.</p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/1.png><img class=img src=/images/veils/1.png alt=Untitled></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/2.png><img class=img src=/images/veils/2.png alt=Untitled></a></p><p>If you set a breakpoint, right before that call, you can inspect the <code>rdx</code> and <code>rax</code> registers to see what was being compared. In this case, the stack reveals a lot more.</p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/3.png><img class=img src=/images/veils/3.png alt=Untitled></a></p><p>And there you have a flag : <code>SHCTF{7r1ck_0r?}</code> ‚Ä¶ quick but unsatisfactory üòï</p><hr><h2 id=intended-path><strong>Intended Path</strong></h2><p>In a perfect program where the set up is a lot more complex than this and leaks do not show this easily, you load this binary on <code>[ghidra](https://ghidra-sre.org/)</code> for some static disassembly. Here is <a href=#the-program-decompiled-on-ghidra>the decompiled program.</a></p><p>You notice a variable holding 24 bytes being loaded into a location <code>VM_MEMORY + 0x70</code> . You notice a loop through that memory location and a switch case with each byte.</p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/4.png><img class=img src=/images/veils/4.png alt=Untitled></a></p><p>Each case performs some execution logic.</p><p><strong>First crack</strong>: This hints at a basic machine for which the custom instructions are the 24 bytes and the execution logic is the switch case!</p><p>You need to perform a custom disassembly. Understand what each opcode does.</p><p>What we know:</p><ol><li><p>The machine has 10 opcodes numbered <code>0x00</code> ‚Üí <code>0xa</code>.</p><p>This is a rough deconstruction of each opcode:</p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/5.png><img class=img src=/images/veils/5.png alt=Untitled></a></p></li><li><p>There are two obfuscated strings that are xor‚Äôd by <code>0x54</code>.</p></li></ol><p><a target=_blank rel="noopener noreferrer" href=/images/veils/6.png><img class=img src=/images/veils/6.png alt=Untitled></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/7.png><img class=img src=/images/veils/7.png alt=Untitled></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/veils/8.png><img class=img src=/images/veils/8.png alt=Untitled></a></p><p>You deconstruct the vm_instructions to this pseudo-decompilation. <a href=#deconstructpy>See the deconstruct.py</a> in the appendix.</p><p>Running the script, you get ‚Äúdecompiled‚Äù code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=mh>0x10</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0xfd3a4a2141450b31</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_38</span><span class=p>,</span> <span class=mh>0x40</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_38</span> <span class=o>=</span> <span class=mh>0xae720975073e3c43</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>xor</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=nx>reg_38</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x53484354467b3772</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>load</span><span class=p>(</span><span class=nx>reg_90</span><span class=p>,</span> <span class=nx>reg_30</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_90</span> <span class=o>=</span> <span class=mh>0x53484354467b3772</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=mh>0x18</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x1516151515151515</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_38</span><span class=p>,</span> <span class=mh>0x48</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_38</span> <span class=o>=</span> <span class=mh>0x1c4d564a1b5d2a68</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>add</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=nx>reg_38</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x31636b5f30723f7d</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>load</span><span class=p>(</span><span class=nx>reg_98</span><span class=p>,</span> <span class=nx>reg_30</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_98</span> <span class=o>=</span> <span class=mh>0x31636b5f30723f7d</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=mh>0x60</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x60</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_38</span><span class=p>,</span> <span class=nx>reg_90</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_38</span> <span class=o>=</span> <span class=mh>0x53484354467b3772</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>cmp</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=nx>reg_38</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x60</span>
</span></span><span class=line><span class=cl><span class=nx>cmp</span><span class=p>(</span><span class=sb>`, SHCTF{7r)
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>mov(reg_38, reg_90, 8)
</span></span></span><span class=line><span class=cl><span class=sb> reg_38 = 0x53484354467b3772
</span></span></span><span class=line><span class=cl><span class=sb>
</span></span></span><span class=line><span class=cl><span class=sb>cmp(reg_30, reg_38, 8)
</span></span></span><span class=line><span class=cl><span class=sb> reg_30 = 0x60
</span></span></span><span class=line><span class=cl><span class=sb>cmp(`</span><span class=p>,</span> <span class=nx>SHCTF</span><span class=p>{</span><span class=mi>7</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=mh>0x68</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x68</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>mov</span><span class=p>(</span><span class=nx>reg_38</span><span class=p>,</span> <span class=nx>reg_98</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_38</span> <span class=o>=</span> <span class=mh>0x31636b5f30723f7d</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>cmp</span><span class=p>(</span><span class=nx>reg_30</span><span class=p>,</span> <span class=nx>reg_38</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=cl> <span class=nx>reg_30</span> <span class=o>=</span> <span class=mh>0x68</span>
</span></span><span class=line><span class=cl><span class=nx>cmp</span><span class=p>(</span><span class=nx>h</span><span class=p>,</span> <span class=mi>1</span><span class=nx>ck_0r</span><span class=o>?</span><span class=p>})</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>print</span><span class=p>(</span><span class=nx>Correct</span> <span class=nx>key</span><span class=o>!</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>exit</span><span class=p>()</span>
</span></span></code></pre></div><p>Behold! your key ‚Üí <code>SHCTF{7r1ck_0r?}</code></p><h2 id=appendix>Appendix</h2><h3 id=the-program-decompiled-on-ghidra>The program decompiled on ghidra.</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>undefined8</span> <span class=nx>main</span><span class=p>(</span><span class=k>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>size_t</span> <span class=nx>sVar1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined8</span> <span class=nx>local_98</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined8</span> <span class=nx>local_90</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>char</span> <span class=nx>local_88</span> <span class=p>[</span><span class=mi>32</span><span class=p>];</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined8</span> <span class=nx>local_68</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined6</span> <span class=nx>local_60</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined2</span> <span class=nx>uStack_5a</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined6</span> <span class=nx>uStack_58</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>int</span> <span class=nx>local_4c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>int</span> <span class=nx>local_48</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>int</span> <span class=nx>local_44</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>int</span> <span class=nx>local_40</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>int</span> <span class=nx>local_3c</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined8</span> <span class=o>*</span><span class=nx>local_38</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined1</span> <span class=o>*</span><span class=nx>local_30</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>byte</span> <span class=o>*</span><span class=nx>local_28</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>undefined8</span> <span class=o>*</span><span class=nx>local_20</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kr>char</span> <span class=o>*</span><span class=nx>local_18</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>ulong</span> <span class=nx>local_10</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                                                 &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                     [+]                         &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                    /   \\                        &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                   /_____\\                       &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                  /       \\                      &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                 /   [_]   \\                     &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                [_______]                        &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;                                                 &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;               [Veiled Dimensions]               \n&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=nx>local_10</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>local_10</span> <span class=o>&lt;</span> <span class=mh>0x10</span><span class=p>;</span> <span class=nx>local_10</span> <span class=o>=</span> <span class=nx>local_10</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>VM_MEMORY</span><span class=p>[</span><span class=nx>local_10</span> <span class=o>+</span> <span class=mh>0x10</span><span class=p>]</span> <span class=o>=</span> <span class=nx>obfuscated_string1</span><span class=p>[</span><span class=nx>local_10</span><span class=p>]</span> <span class=o>^</span> <span class=mh>0x54</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>VM_MEMORY</span><span class=p>[</span><span class=nx>local_10</span> <span class=o>+</span> <span class=mh>0x40</span><span class=p>]</span> <span class=o>=</span> <span class=nx>obfuscated_string2</span><span class=p>[</span><span class=nx>local_10</span><span class=p>]</span> <span class=o>^</span> <span class=mh>0x54</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>VM_MEMORY</span><span class=p>[</span><span class=mi>32</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>VM_MEMORY</span><span class=p>[</span><span class=mi>80</span><span class=p>]</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_68</span> <span class=o>=</span> <span class=mh>0x1800040240011000</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_60</span> <span class=o>=</span> <span class=mh>0x600005034801</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>uStack_5a</span> <span class=o>=</span> <span class=mh>0x806</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>uStack_58</span> <span class=o>=</span> <span class=mh>0xa0908076800</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>printf</span><span class=p>(</span><span class=s2>&#34;Enter the key: &#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>fgets</span><span class=p>(</span><span class=nx>local_88</span><span class=p>,</span><span class=mh>0x12</span><span class=p>,(</span><span class=nx>FILE</span> <span class=o>*</span><span class=p>)</span><span class=nx>stdin</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>sVar1</span> <span class=o>=</span> <span class=nx>strcspn</span><span class=p>(</span><span class=nx>local_88</span><span class=p>,</span><span class=s2>&#34;\n&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_88</span><span class=p>[</span><span class=nx>sVar1</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;\0&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_18</span> <span class=o>=</span> <span class=nx>VM_MEMORY</span> <span class=o>+</span> <span class=mh>0x70</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_20</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nx>local_68</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>while</span> <span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kr>char</span> <span class=o>*</span><span class=p>)</span><span class=nx>local_20</span> <span class=o>!=</span> <span class=s1>&#39;\n&#39;</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=nx>local_18</span> <span class=o>=</span> <span class=o>*</span><span class=p>(</span><span class=kr>char</span> <span class=o>*</span><span class=p>)</span><span class=nx>local_20</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>local_20</span> <span class=o>=</span> <span class=p>(</span><span class=nx>undefined8</span> <span class=o>*</span><span class=p>)((</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_20</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=nx>local_18</span> <span class=o>=</span> <span class=nx>local_18</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=nx>strncpy</span><span class=p>(</span><span class=nx>VM_MEMORY</span> <span class=o>+</span> <span class=mh>0x60</span><span class=p>,</span><span class=nx>local_88</span><span class=p>,</span><span class=mh>0x10</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_28</span> <span class=o>=</span> <span class=nx>VM_MEMORY</span> <span class=o>+</span> <span class=mh>0x70</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_30</span> <span class=o>=</span> <span class=p>(</span><span class=nx>undefined1</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_38</span> <span class=o>=</span> <span class=p>(</span><span class=nx>undefined8</span> <span class=o>*</span><span class=p>)</span><span class=mh>0x0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_90</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=nx>local_98</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=k>do</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>*</span><span class=nx>local_28</span> <span class=o>==</span> <span class=mi>10</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>printf</span><span class=p>(</span><span class=s2>&#34;%x &#34;</span><span class=p>,(</span><span class=nx>ulong</span><span class=p>)</span><span class=o>*</span><span class=nx>local_28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>switch</span><span class=p>(</span><span class=o>*</span><span class=nx>local_28</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>0</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>local_28</span> <span class=o>=</span> <span class=nx>local_28</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>local_30</span> <span class=o>=</span> <span class=nx>VM_MEMORY</span> <span class=o>+</span> <span class=o>*</span><span class=nx>local_28</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>1</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>local_28</span> <span class=o>=</span> <span class=nx>local_28</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=nx>local_38</span> <span class=o>=</span> <span class=p>(</span><span class=nx>undefined8</span> <span class=o>*</span><span class=p>)(</span><span class=nx>VM_MEMORY</span> <span class=o>+</span> <span class=o>*</span><span class=nx>local_28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>3</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>local_48</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>local_48</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>local_48</span> <span class=o>=</span> <span class=nx>local_48</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>local_30</span><span class=p>[</span><span class=nx>local_48</span><span class=p>]</span> <span class=o>=</span> <span class=nx>local_30</span><span class=p>[</span><span class=nx>local_48</span><span class=p>]</span> <span class=o>+</span> <span class=o>*</span><span class=p>(</span><span class=kr>char</span> <span class=o>*</span><span class=p>)((</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_38</span> <span class=o>+</span> <span class=p>(</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_48</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>4</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>local_3c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>local_3c</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>local_3c</span> <span class=o>=</span> <span class=nx>local_3c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>local_88</span><span class=p>[(</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_3c</span> <span class=o>+</span> <span class=o>-</span><span class=mi>8</span><span class=p>]</span> <span class=o>=</span> <span class=nx>local_30</span><span class=p>[</span><span class=nx>local_3c</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>5</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>local_40</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>local_40</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>local_40</span> <span class=o>=</span> <span class=nx>local_40</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=o>*</span><span class=p>(</span><span class=nx>undefined1</span> <span class=o>*</span><span class=p>)((</span><span class=kr>long</span><span class=p>)</span><span class=o>&amp;</span><span class=nx>local_98</span> <span class=o>+</span> <span class=p>(</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_40</span><span class=p>)</span> <span class=o>=</span> <span class=nx>local_30</span><span class=p>[</span><span class=nx>local_40</span><span class=p>];</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>local_44</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>local_44</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>local_44</span> <span class=o>=</span> <span class=nx>local_44</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>local_30</span><span class=p>[</span><span class=nx>local_44</span><span class=p>]</span> <span class=o>=</span> <span class=nx>local_30</span><span class=p>[</span><span class=nx>local_44</span><span class=p>]</span> <span class=o>^</span> <span class=o>*</span><span class=p>(</span><span class=kr>byte</span> <span class=o>*</span><span class=p>)((</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_38</span> <span class=o>+</span> <span class=p>(</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_44</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>6</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>local_38</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nx>local_90</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>7</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>local_38</span> <span class=o>=</span> <span class=o>&amp;</span><span class=nx>local_98</span><span class=p>;</span>
</span></span><span class=line><span class=cl>      <span class=k>break</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>8</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=nx>local_4c</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>local_4c</span> <span class=o>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>local_4c</span> <span class=o>=</span> <span class=nx>local_4c</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nx>local_30</span><span class=p>[</span><span class=nx>local_4c</span><span class=p>]</span> <span class=o>!=</span> <span class=o>*</span><span class=p>(</span><span class=kr>char</span> <span class=o>*</span><span class=p>)((</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_38</span> <span class=o>+</span> <span class=p>(</span><span class=kr>long</span><span class=p>)</span><span class=nx>local_4c</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>          <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;Incorrect key!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>          <span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>case</span> <span class=mi>9</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>puts</span><span class=p>(</span><span class=s2>&#34;Correct key!&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>      <span class=nx>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>default</span><span class=o>:</span>
</span></span><span class=line><span class=cl>      <span class=nx>printf</span><span class=p>(</span><span class=s2>&#34;Invalid instruction: %x\n&#34;</span><span class=p>,(</span><span class=nx>ulong</span><span class=p>)</span><span class=o>*</span><span class=nx>local_28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=cm>/* WARNING: Subroutine does not return */</span>
</span></span><span class=line><span class=cl>      <span class=nx>exit</span><span class=p>(</span><span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nx>local_28</span> <span class=o>=</span> <span class=nx>local_28</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span> <span class=k>while</span><span class=p>(</span> <span class=kc>true</span> <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=deconstructpy>deconstruct.py</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=kr>class</span> <span class=nx>VMParser</span><span class=o>:</span>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>__init__</span><span class=p>(</span><span class=nx>self</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>vm_rodata</span> <span class=o>=</span> <span class=p>{}</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reg_30&#34;</span><span class=o>:</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reg_38&#34;</span><span class=o>:</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reg_90&#34;</span><span class=o>:</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>            <span class=s2>&#34;reg_98&#34;</span><span class=o>:</span> <span class=mh>0x0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>opcodes</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>_initialize_opcodes</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=err>@</span><span class=nx>staticmethod</span>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>reverse_qword_order</span><span class=p>(</span><span class=nx>num</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>hex_str</span> <span class=o>=</span> <span class=nx>format</span><span class=p>(</span><span class=nx>num</span><span class=p>,</span> <span class=s1>&#39;016x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=s1>&#39;&#39;</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>reversed</span><span class=p>([</span><span class=nx>hex_str</span><span class=p>[</span><span class=nx>i</span><span class=o>:</span><span class=nx>i</span><span class=o>+</span><span class=mi>2</span><span class=p>]</span> <span class=k>for</span> <span class=nx>i</span> <span class=k>in</span> <span class=nx>range</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=nx>len</span><span class=p>(</span><span class=nx>hex_str</span><span class=p>),</span> <span class=mi>2</span><span class=p>)]))</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>_initialize_opcodes</span><span class=p>(</span><span class=nx>self</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x00</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;mov: reg_30, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x01</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;mov: reg_38, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x02</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;xor: reg_30, reg_38, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x03</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;add: reg_30, reg_38, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x04</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;load: reg_90, reg_30, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x05</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;load: reg_98, reg_30, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span> 
</span></span><span class=line><span class=cl>            <span class=mh>0x06</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;mov: reg_38, reg_90, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x07</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;mov: reg_38, reg_98, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x08</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;cmp: reg_30, reg_38, 8&#34;</span><span class=p>,</span> <span class=nx>self</span><span class=p>.</span><span class=nx>parse_ops</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x09</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;print(Correct key!)&#34;</span><span class=p>,</span> <span class=nx>None</span><span class=p>),</span>
</span></span><span class=line><span class=cl>            <span class=mh>0x0a</span><span class=o>:</span> <span class=p>(</span><span class=s2>&#34;exit()&#34;</span><span class=p>,</span> <span class=nx>None</span><span class=p>),</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>get_addr_value</span><span class=p>(</span><span class=nx>self</span><span class=p>,</span> <span class=nx>instructions</span><span class=p>,</span> <span class=nx>idx</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>value</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=nx>addr</span> <span class=o>=</span> <span class=kr>int</span><span class=p>(</span><span class=nx>instructions</span><span class=p>[</span><span class=nx>idx</span><span class=o>+</span><span class=mi>2</span><span class=o>:</span> <span class=nx>idx</span><span class=o>+</span><span class=mi>4</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>round_addr</span> <span class=o>=</span> <span class=nx>addr</span> <span class=o>&amp;</span> <span class=mh>0xf0</span>
</span></span><span class=line><span class=cl>            <span class=nx>offset</span> <span class=o>=</span> <span class=nx>addr</span> <span class=o>-</span> <span class=nx>round_addr</span>
</span></span><span class=line><span class=cl>            <span class=nx>offset</span> <span class=o>=</span> <span class=mi>16</span> <span class=k>if</span> <span class=nx>offset</span> <span class=o>&gt;</span> <span class=mi>0</span> <span class=k>else</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>            <span class=nx>value</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>vm_rodata</span><span class=p>[</span><span class=nx>round_addr</span><span class=p>][</span><span class=nx>offset</span><span class=o>:</span> <span class=nx>offset</span><span class=o>+</span><span class=mi>16</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nx>value</span> <span class=o>=</span> <span class=kr>int</span><span class=p>(</span><span class=nx>value</span><span class=p>,</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>except</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>value</span> <span class=o>=</span> <span class=nx>addr</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>hex</span><span class=p>(</span><span class=nx>addr</span><span class=p>),</span> <span class=nx>value</span><span class=p>,</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>parse_ops</span><span class=p>(</span><span class=nx>self</span><span class=p>,</span> <span class=nx>instructions</span><span class=p>,</span> <span class=nx>idx</span><span class=p>,</span> <span class=nx>descr</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>steps</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=nx>ops_params</span> <span class=o>=</span> <span class=nx>descr</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;: &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nx>ops</span> <span class=o>=</span> <span class=nx>ops_params</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>params</span> <span class=o>=</span> <span class=nx>ops_params</span><span class=p>[</span><span class=mi>1</span><span class=p>].</span><span class=nx>split</span><span class=p>(</span><span class=s1>&#39;, &#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nx>reg_1</span> <span class=o>=</span> <span class=nx>params</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>reg_2</span> <span class=o>=</span> <span class=nx>params</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=k>if</span> <span class=nx>len</span><span class=p>(</span><span class=nx>params</span><span class=p>)</span> <span class=o>==</span> <span class=mi>3</span> <span class=k>else</span> <span class=nx>None</span>
</span></span><span class=line><span class=cl>        <span class=nx>size</span> <span class=o>=</span> <span class=kr>int</span><span class=p>(</span><span class=nx>params</span><span class=p>[</span><span class=o>-</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ops</span> <span class=o>==</span> <span class=s2>&#34;xor&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>]</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>]</span> <span class=o>^</span> <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>elif</span> <span class=nx>ops</span> <span class=o>==</span> <span class=s2>&#34;add&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>]</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>]</span> <span class=o>+</span> <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>elif</span> <span class=nx>ops</span> <span class=o>==</span> <span class=s2>&#34;load&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>]</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>elif</span> <span class=nx>ops</span> <span class=o>==</span> <span class=s2>&#34;mov&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>len</span><span class=p>(</span><span class=nx>params</span><span class=p>)</span> <span class=o>==</span> <span class=mi>2</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=err>#</span> <span class=nx>get</span> <span class=nx>value</span> <span class=nx>from</span> <span class=nx>address</span> 
</span></span><span class=line><span class=cl>                <span class=nx>addr</span><span class=p>,</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>steps</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>get_addr_value</span><span class=p>(</span><span class=nx>instructions</span><span class=p>,</span> <span class=nx>idx</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>value</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_2</span><span class=p>]</span>
</span></span><span class=line><span class=cl>            <span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>]</span> <span class=o>=</span> <span class=nx>value</span>
</span></span><span class=line><span class=cl>            
</span></span><span class=line><span class=cl>        <span class=nx>descr</span> <span class=o>=</span> <span class=nx>f</span><span class=s2>&#34;{ops}({reg_1}, {addr if reg_2 is None else reg_2}, {size})\n {reg_1} = {hex(self.registers[reg_1])}\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>ops</span> <span class=o>==</span> <span class=s2>&#34;cmp&#34;</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=err>#</span> <span class=kr>int</span> <span class=nx>to</span> <span class=nx>ascii</span>
</span></span><span class=line><span class=cl>            <span class=nx>reg_1</span> <span class=o>=</span> <span class=nx>format</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_1</span><span class=p>],</span> <span class=s1>&#39;x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>reg_1</span> <span class=o>=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>fromhex</span><span class=p>(</span><span class=nx>reg_1</span><span class=p>).</span><span class=nx>decode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>reg_2</span> <span class=o>=</span> <span class=nx>format</span><span class=p>(</span><span class=nx>self</span><span class=p>.</span><span class=nx>registers</span><span class=p>[</span><span class=nx>reg_2</span><span class=p>],</span> <span class=s1>&#39;x&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>reg_2</span> <span class=o>=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>fromhex</span><span class=p>(</span><span class=nx>reg_2</span><span class=p>).</span><span class=nx>decode</span><span class=p>(</span><span class=s2>&#34;ascii&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=nx>descr</span> <span class=o>+=</span> <span class=nx>f</span><span class=s2>&#34;cmp({reg_1}, {reg_2})\n&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=nx>descr</span><span class=p>,</span> <span class=nx>steps</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>execute</span><span class=p>(</span><span class=nx>self</span><span class=p>,</span> <span class=nx>instructions</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>len</span><span class=p>(</span><span class=nx>instructions</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>            <span class=nx>descr</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nx>inst</span> <span class=o>=</span> <span class=kr>int</span><span class=p>(</span><span class=nx>instructions</span><span class=p>[</span><span class=nx>i</span><span class=o>:</span> <span class=nx>i</span><span class=o>+</span><span class=mi>2</span><span class=p>],</span> <span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>inst</span> <span class=k>in</span> <span class=nx>self</span><span class=p>.</span><span class=nx>opcodes</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>descr</span> <span class=o>+=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>opcodes</span><span class=p>[</span><span class=nx>inst</span><span class=p>][</span><span class=mi>0</span><span class=p>]</span>
</span></span><span class=line><span class=cl>                <span class=k>if</span> <span class=nx>self</span><span class=p>.</span><span class=nx>opcodes</span><span class=p>[</span><span class=nx>inst</span><span class=p>][</span><span class=mi>1</span><span class=p>]</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                    <span class=nx>descr</span><span class=p>,</span> <span class=nx>skips</span> <span class=o>=</span> <span class=nx>self</span><span class=p>.</span><span class=nx>opcodes</span><span class=p>[</span><span class=nx>inst</span><span class=p>][</span><span class=mi>1</span><span class=p>](</span><span class=nx>instructions</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>descr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                    <span class=nx>i</span> <span class=o>+=</span> <span class=nx>skips</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span><span class=o>:</span>
</span></span><span class=line><span class=cl>                <span class=nx>descr</span> <span class=o>+=</span> <span class=nx>f</span><span class=s2>&#34;Unknown instruction: {hex(inst)}&#34;</span>
</span></span><span class=line><span class=cl>            <span class=nx>print</span><span class=p>(</span><span class=nx>descr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=nx>i</span> <span class=o>=</span> <span class=nx>i</span><span class=o>+</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>load_instructions</span><span class=p>(</span><span class=nx>self</span><span class=p>,</span> <span class=nx>vm_instructions</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>rev_instr</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>.</span><span class=nx>join</span><span class=p>([</span><span class=nx>self</span><span class=p>.</span><span class=nx>reverse_qword_order</span><span class=p>(</span><span class=nx>x</span><span class=p>)</span> <span class=k>for</span> <span class=nx>x</span> <span class=k>in</span> <span class=nx>vm_instructions</span><span class=p>])</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>vm_rodata</span><span class=p>[</span><span class=mh>0x70</span><span class=p>]</span> <span class=o>=</span> <span class=nx>rev_instr</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nx>def</span> <span class=nx>load_obfuscated_strings</span><span class=p>(</span><span class=nx>self</span><span class=p>,</span> <span class=nx>obfuscated_string</span><span class=p>,</span> <span class=nx>address</span><span class=p>,</span> <span class=nx>key</span><span class=o>=</span><span class=mh>0x5454545454545454</span><span class=p>)</span><span class=o>:</span>
</span></span><span class=line><span class=cl>        <span class=nx>processed_string</span> <span class=o>=</span> <span class=p>[</span><span class=nx>self</span><span class=p>.</span><span class=nx>reverse_qword_order</span><span class=p>(</span><span class=nx>x</span> <span class=o>^</span> <span class=nx>key</span><span class=p>)</span> <span class=k>for</span> <span class=nx>x</span> <span class=k>in</span> <span class=nx>obfuscated_string</span><span class=p>]</span>
</span></span><span class=line><span class=cl>        <span class=nx>self</span><span class=p>.</span><span class=nx>vm_rodata</span><span class=p>[</span><span class=nx>address</span><span class=p>]</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>.</span><span class=nx>join</span><span class=p>(</span><span class=nx>processed_string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=err>#</span> <span class=nx>Example</span> <span class=nx>usage</span>
</span></span><span class=line><span class=cl><span class=nx>parser</span> <span class=o>=</span> <span class=nx>VMParser</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nx>parser</span><span class=p>.</span><span class=nx>load_instructions</span><span class=p>([</span><span class=mh>0x1800040240011000</span><span class=p>,</span> <span class=mh>0x0806600005034801</span><span class=p>,</span> <span class=mh>0x0a09080768000806</span><span class=p>])</span>
</span></span><span class=line><span class=cl><span class=nx>parser</span><span class=p>.</span><span class=nx>load_obfuscated_strings</span><span class=p>([</span><span class=mh>0x655F1115751E6EA9</span><span class=p>,</span> <span class=mh>0x4141414141414241</span><span class=p>],</span> <span class=mh>0x10</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>parser</span><span class=p>.</span><span class=nx>load_obfuscated_strings</span><span class=p>([</span><span class=mh>0x17686A53215D26FA</span><span class=p>,</span> <span class=mh>0x3C7E094F1E021948</span><span class=p>],</span> <span class=mh>0x40</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nx>parser</span><span class=p>.</span><span class=nx>execute</span><span class=p>(</span><span class=nx>parser</span><span class=p>.</span><span class=nx>vm_rodata</span><span class=p>[</span><span class=mh>0x70</span><span class=p>])</span>
</span></span></code></pre></div></article><section class=article-labels><a class="article-category li" href=/categories/ctf-writeups/><span class=hashtag>#</span>CTF WriteUps</a><a class="article-tag li" href=/tags/shctf/><span class=hashtag>#</span>shctf</a><a class="article-tag li" href=/tags/vm-based-obfuscation/><span class=hashtag>#</span>vm-based obfuscation</a></section><section class=article-navigation><p><a class=link href=/posts/snotes/><span class=li></span>SHCTF23: SecureNotes3</a></p><p><a class=link href=/posts/case_08/><span class=li></span>Case 08 ‚Üí Caught a Runner‚Äôs High üò∂‚Äçüå´Ô∏è</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>¬© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>