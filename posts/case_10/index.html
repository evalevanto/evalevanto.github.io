<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.121.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>Case 10 ‚Üí The Battle Of Trojan üê¥&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>Case 10 ‚Üí The Battle Of Trojan üê¥</h1><p class=article-date>2023-12-13</p></section><article class=markdown-body><p><strong>Background</strong>:¬†<strong>There&rsquo;s this sneaky trojan component called <code>KuandaListener</code> lurking in the machine.</strong></p><p><strong>Mission: Dive into captured logs and figure out what the trojan is up to.</strong></p><p><strong>For all the marbles: Find anything that can help.</strong></p><blockquote><p><em>I almost fell off the wagon of not completing missions‚Ä¶ not this time.</em></p></blockquote><p>We do not have a lot to go on expect the logs.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>KuandaLogs</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>take</span> <span class=mi>50</span>
</span></span></code></pre></div><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/10_0.png><img class=img src=/images/kusto/10_0.png alt></a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>KuandaLogs</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>summarize</span> <span class=nx>count</span><span class=p>()</span> <span class=nx>by</span> <span class=nx>substring</span><span class=p>(</span><span class=nx>Message</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=mi>10</span><span class=p>)</span>
</span></span></code></pre></div><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/10_1.png><img class=img src=/images/kusto/10_1.png alt></a></p><p>A sample <code>sending an..</code> message looks like: <code>Sending an encrypted message, will use Dekrypt(@'mbNYouohoQThoQKpoQNeou5eobUqoQUYoQUYozJ\N[hO9m0T9nZbVPjvVPN5ciR4\PjqVm159mX5VPjDMENqsgX51vO3MgY5\vp5MPRb\HZhFm\D9PlCNWAOcgZbVPjvVPjbNBl3N[zSlHZYciAuVPSbMEjbNBl3NWzvMvCTNBlkVPSCNBS0cElCMnZk9mI4cD[=', strcat_array(&lt;active-user-encryption-tokens>, '')) for decoding.</code></p><p>Looking at the logs of a particular compromised user, you learn the token is sent in an operation message and is active until the operation is completed or the session is reset.</p><p>Can we find the <code>active-user-encryption-tokens</code>?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>.</span><span class=nx>set</span><span class=o>-</span><span class=nx>or</span><span class=o>-</span><span class=nx>replace</span> <span class=nx>LogsEx</span> <span class=o>&lt;|</span>
</span></span><span class=line><span class=cl><span class=nx>KuandaLogs</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>where</span> <span class=nx>Message</span> <span class=nx>has</span> <span class=s2>&#34;Sending an&#34;</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>distinct</span> <span class=nx>DetectiveId</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>lookup</span> <span class=nx>kind</span><span class=o>=</span><span class=nx>inner</span> <span class=nx>KuandaLogs</span> <span class=nx>on</span> <span class=nx>DetectiveId</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>parse</span> <span class=nx>Message</span> <span class=kd>with</span> <span class=s2>&#34;Operation id=&#34;</span> <span class=nx>OpId</span><span class=o>:</span><span class=nx>string</span> <span class=s2>&#34; &#34;</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>parse</span> <span class=nx>Message</span> <span class=kd>with</span> <span class=o>*</span> <span class=s2>&#34;token: &#39;&#34;</span> <span class=nx>Token</span><span class=o>:</span><span class=nx>string</span> <span class=s2>&#34;&#39;.&#34;</span> <span class=c1>// parse opID and token from the message string
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span> <span class=nx>extend</span> <span class=nx>Ev</span> <span class=o>=</span> <span class=nx>iff</span><span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>Message</span> <span class=nx>has_all</span> <span class=p>(</span><span class=s2>&#34;Operation&#34;</span><span class=p>,</span> <span class=s2>&#34;completed&#34;</span><span class=p>),</span> <span class=s2>&#34;OpCompleted&#34;</span><span class=p>,</span> <span class=nx>iff</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>Message</span> <span class=nx>has_all</span><span class=p>(</span><span class=s2>&#34;Operation&#34;</span><span class=p>,</span> <span class=s2>&#34;started&#34;</span><span class=p>),</span> <span class=s2>&#34;OpStarted&#34;</span><span class=p>,</span> <span class=nx>iff</span><span class=p>(</span>
</span></span><span class=line><span class=cl>            <span class=nx>Message</span> <span class=nx>has</span> <span class=s2>&#34;User session reset&#34;</span><span class=p>,</span> <span class=s2>&#34;SessionReset&#34;</span><span class=p>,</span> <span class=nx>iff</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=nx>Message</span> <span class=nx>has</span> <span class=s2>&#34;entered&#34;</span><span class=p>,</span> <span class=s2>&#34;SessionStart&#34;</span><span class=p>,</span> <span class=nx>iff</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                    <span class=nx>Message</span> <span class=nx>has</span> <span class=s2>&#34;Sending&#34;</span><span class=p>,</span> <span class=s2>&#34;MessageSent&#34;</span><span class=p>,</span> <span class=s2>&#34;Unknown&#34;</span><span class=p>)))))</span> <span class=c1>// create new column for events
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>|</span> <span class=nx>project</span> <span class=nx>DetectiveId</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>,</span> <span class=nx>Ev</span><span class=p>,</span> <span class=nx>OpId</span><span class=p>,</span> <span class=nx>Token</span><span class=p>,</span> <span class=nx>Message</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>partition</span> <span class=nx>hint</span><span class=p>.</span><span class=nx>strategy</span><span class=o>=</span><span class=kr>native</span> <span class=nx>by</span> <span class=nx>DetectiveId</span>
</span></span><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=nx>order</span> <span class=nx>by</span> <span class=nx>Timestamp</span> <span class=nx>asc</span> <span class=p>);</span>
</span></span></code></pre></div><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/10_2.png><img class=img src=/images/kusto/10_2.png alt></a></p><p>The task is to find active tokens that are used to send the encrypted messages.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>LogsEx</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>partition</span> <span class=nx>hint</span><span class=p>.</span><span class=nx>strategy</span><span class=o>=</span><span class=kr>native</span> <span class=nx>by</span> <span class=nx>DetectiveId</span>
</span></span><span class=line><span class=cl><span class=p>(</span>
</span></span><span class=line><span class=cl><span class=nx>order</span> <span class=nx>by</span> <span class=nx>Timestamp</span> <span class=nx>asc</span>
</span></span><span class=line><span class=cl>    <span class=o>|</span> <span class=nx>scan</span> <span class=nx>declare</span><span class=p>(</span><span class=nx>Active</span><span class=o>:</span><span class=nx>string</span><span class=p>)</span> <span class=kd>with</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>    <span class=nx>step</span> <span class=nx>start</span> <span class=nx>output</span><span class=o>=</span><span class=nx>none</span><span class=o>:</span> <span class=nx>Ev</span> <span class=nx>has_any</span><span class=p>(</span><span class=s2>&#34;SessionStart&#34;</span><span class=p>,</span> <span class=s2>&#34;SessionReset&#34;</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>Active</span><span class=o>=</span><span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nx>step</span> <span class=nx>ops</span> <span class=nx>output</span><span class=o>=</span><span class=nx>none</span><span class=o>:</span> <span class=nx>Ev</span> <span class=nx>has_any</span> <span class=p>(</span><span class=s2>&#34;OpStarted&#34;</span><span class=p>,</span> <span class=s2>&#34;OpCompleted&#34;</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=nx>Active</span> <span class=o>=</span> <span class=nx>iff</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=nx>Ev</span> <span class=o>==</span> <span class=s2>&#34;OpStarted&#34;</span><span class=p>,</span> <span class=nx>strcat</span><span class=p>(</span><span class=nx>ops</span><span class=p>.</span><span class=nx>Active</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>,</span> <span class=nx>OpId</span><span class=p>),</span> <span class=nx>replace_string</span><span class=p>(</span><span class=nx>ops</span><span class=p>.</span><span class=nx>Active</span><span class=p>,</span> <span class=nx>OpId</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=nx>step</span> <span class=nx>send</span><span class=o>:</span> <span class=nx>Ev</span> <span class=nx>has</span> <span class=s2>&#34;MessageSent&#34;</span> <span class=p>=&gt;</span> <span class=nx>Active</span><span class=o>=</span><span class=nx>ops</span><span class=p>.</span><span class=nx>Active</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>      
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>project</span> <span class=nx>Timestamp</span><span class=p>,</span> <span class=nx>DetectiveId</span><span class=p>,</span> <span class=nx>OpId</span><span class=o>=</span><span class=nx>Active</span><span class=p>,</span> <span class=nx>Message</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>Here, you are gathering operations (by Id) that would be active when the encrypted message is sent.</p><p>Now, grab the tokens corresponding for each message from the active operations.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>mv</span><span class=o>-</span><span class=nx>expand</span> <span class=nx>split</span><span class=p>(</span><span class=nx>OpId</span><span class=p>,</span> <span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=nx>to</span> <span class=k>typeof</span><span class=p>(</span><span class=nx>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>join</span> <span class=nx>kind</span><span class=o>=</span><span class=nx>inner</span> <span class=p>(</span><span class=nx>LogsEx</span> <span class=o>|</span> <span class=nx>where</span> <span class=nx>Message</span> <span class=nx>has</span> <span class=s2>&#34;token: &#39;&#34;</span><span class=p>)</span> <span class=nx>on</span> <span class=nx>OpId</span> 
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>sort</span> <span class=nx>by</span> <span class=nx>DetectiveId</span><span class=p>,</span> <span class=nx>Timestamp1</span> <span class=nx>asc</span><span class=p>,</span> <span class=nx>Message</span><span class=p>,</span> <span class=nx>Timestamp</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>summarize</span> <span class=nx>Key</span><span class=o>=</span><span class=nx>make_list</span><span class=p>(</span><span class=nx>Token</span><span class=p>)</span> <span class=nx>by</span> <span class=nx>DetectiveId</span><span class=p>,</span> <span class=nx>Timestamp</span><span class=p>,</span> <span class=nx>Message</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>parse</span> <span class=nx>Message</span> <span class=kd>with</span> <span class=s2>&#34;Sending an encrypted message, will use Dekrypt(@&#39;&#34;</span> <span class=nx>Encrypted</span> <span class=s2>&#34;&#39;,&#34;</span> <span class=o>*</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>project</span> <span class=nx>Message</span><span class=o>=</span><span class=nx>Encrypted</span><span class=p>,</span> <span class=nx>Key</span><span class=o>=</span><span class=nx>strcat_array</span><span class=p>(</span><span class=nx>Key</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>...</span>
</span></span></code></pre></div><p>Then, decryption!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=p>...</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>invoke</span> <span class=nx>Dekrypt</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>where</span> <span class=nx>Result</span> <span class=o>!</span><span class=nx>has</span> <span class=s2>&#34;Packing&#34;</span> <span class=nx>and</span> <span class=nx>Result</span> <span class=o>!</span><span class=nx>has</span> <span class=s2>&#34;Kuanda&#34;</span> <span class=c1>// filter for interestingness
</span></span></span></code></pre></div><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/10_3.png><img class=img src=/images/kusto/10_3.png alt></a></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=p>[</span><span class=mi>2023</span><span class=o>-</span><span class=mi>09</span><span class=o>-</span><span class=mi>22</span><span class=nx>T03</span><span class=o>:</span><span class=mi>48</span><span class=o>:</span><span class=mf>30.0000000</span><span class=nx>Z</span><span class=p>]</span> <span class=nx>TODO</span> <span class=p>[</span><span class=nx>BUGBUG</span><span class=p>]</span><span class=o>:</span> <span class=nx>Validate</span><span class=o>:</span> <span class=nx>bitset_count_ones</span><span class=p>(</span><span class=nx>hash_many</span><span class=p>(</span><span class=s1>&#39;kvc2f916b75d21076bc100&#39;</span><span class=p>,</span> <span class=nx>tostring</span><span class=p>(</span><span class=nx>$user_answer</span><span class=p>)))</span> <span class=o>&lt;</span> <span class=mi>54</span><span class=o>!</span> <span class=nx>Leaving</span> <span class=nx>as</span><span class=o>-</span><span class=nx>is</span> <span class=k>for</span> <span class=nx>now</span><span class=p>,</span> <span class=nx>the</span> <span class=nx>chance</span> <span class=nx>it</span> <span class=nx>will</span> <span class=nx>actually</span> <span class=nx>happen</span> <span class=nx>is</span> <span class=nx>very</span> <span class=nx>low</span><span class=p>.</span> <span class=p>(</span><span class=nx>O</span> <span class=nx>boy</span><span class=p>,</span> <span class=nx>these</span> <span class=nx>non</span><span class=o>-</span><span class=nx>AMD</span> <span class=nx>processors</span> <span class=nx>are</span> <span class=nx>literally</span> <span class=nx>melting</span> <span class=nx>down</span> <span class=nx>on</span> <span class=nx>invalid</span> <span class=nx>instruction</span> <span class=nx>sets</span><span class=o>!</span><span class=p>)</span>
</span></span></code></pre></div><p>The bug is because the <code>user_answer</code> is wrong. The check is <code>bitset_count_ones(hash_many('&lt;kvc_cluster_id>', tostring($user_answer))) &lt; 54</code></p><p>Can you brute force the correct <code>user_answer</code>?</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-jsx data-lang=jsx><span class=line><span class=cl><span class=nx>range</span> <span class=nx>answer</span> <span class=nx>from</span> <span class=mi>0</span> <span class=nx>to</span> <span class=nx>tolong</span><span class=p>(</span><span class=mi>2147483647</span><span class=p>)</span> <span class=nx>step</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>where</span> <span class=nx>bitset_count_ones</span><span class=p>(</span><span class=nx>hash_many</span><span class=p>(</span><span class=s1>&#39;&lt;kvc_cluster_id&gt;&#39;</span><span class=p>,</span> <span class=nx>tostring</span><span class=p>(</span><span class=nx>answer</span><span class=p>)))</span> <span class=o>&gt;</span> <span class=mi>54</span>
</span></span><span class=line><span class=cl><span class=o>|</span> <span class=nx>limit</span> <span class=mi>1</span>
</span></span></code></pre></div><p><a target=_blank rel="noopener noreferrer" href=/images/kusto/10_4.png><img class=img src=/images/kusto/10_4.png alt></a></p></article><section class=article-labels><a class="article-category li" href=/categories/kusto-detective-agency/><span class=hashtag>#</span>Kusto Detective Agency</a><a class="article-tag li" href=/tags/kql/><span class=hashtag>#</span>kql</a></section><section class=article-navigation><p><a class=link href=/posts/its_on_fire/><span class=li></span>It's On Fire! üî•</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>¬© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>