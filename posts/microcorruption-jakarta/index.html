<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.119.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>MicroCorruption: Jakarta&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>MicroCorruption: Jakarta</h1><p class=article-date>2020-11-04</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta.jpg><img class=img src=/images/microcorruption/jakarta/jakarta.jpg alt></a></p><p>There&rsquo;s a manual:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-dets.png><img class=img src=/images/microcorruption/jakarta/jakarta-dets.png alt></a></p><ul><li>Passwords that are <strong>too long are rejected</strong>. There is additional mechanisms to <strong>verify password length</strong>.</li><li>The lock is <strong>attached to</strong> LockIT Pro <strong>HSM-1</strong>.</li></ul><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-hsm1.png><img class=img src=/images/microcorruption/jakarta/jakarta-hsm1.png alt></a></p><p>The <code>main</code> function just calls <code>login</code>.</p><p><code>login</code> function is quite long:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-input-dets.png><img class=img src=/images/microcorruption/jakarta/jakarta-input-dets.png alt></a>
<a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-login-2.png><img class=img src=/images/microcorruption/jakarta/jakarta-login-2.png alt></a>
<a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-login-3.png><img class=img src=/images/microcorruption/jakarta/jakarta-login-3.png alt></a></p><ul><li><p>Authentication requires a username and password input. The prompt states that these inputs together may <strong>not be more than 32 characters</strong>. :D</p></li><li><p>The <code>gets</code> function for getting the <strong>username</strong>:</p><ul><li><strong>length</strong> of input buffer: held at <code>r14</code> -> <code>0xff(255)</code> characters. Mmmh, <em>interesting</em> considering the <em>rule</em> provided earlier.</li><li><strong>address</strong> to the input buffer: held at <code>r15</code> -> <code>0x2402</code>.</li></ul></li><li><p>There is a length check on the username input:</p></li></ul><pre tabindex=0><code>r15 = 0x2402
for *r15 != 0{
	r15++
}

r11 = r15
r11 -= 0x2402 ; this gives the length of the username input.

cmp.b(0x21, r11) ; this compares if the input is less than 0x21(33) characters.
		; checks the carry flag. jnc implies the input length less than 0x21.
</code></pre><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-jnc.png><img class=img src=/images/microcorruption/jakarta/jakarta-jnc.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-carry.jpg><img class=img src=/images/microcorruption/jakarta/jakarta-carry.jpg alt></a></p><ul><li>Call to <code>strcpy()</code>. The username input copied to <code>0x3ff2</code>.(this is the address the stack pointer points to).</li><li>The <code>gets</code> function for getting <strong>password</strong>:<ul><li><strong>length</strong> of input buffer: at <code>r14</code> -> <code>0x1f(31) - r11(length of username input) & 0x1ff</code> characters. Capped at 31 characters. (This is maximum input, in case username was empty.)</li><li><strong>address</strong> to input buffer: at <code>r15</code> -> <code>0x2402</code>.</li></ul></li></ul><blockquote><p>An interesting discovery on calculating the length of input passed to <code>getsn</code> on the password input.</p><p>If the username input is maximum length, a <strong>buffer underflow</strong> occurs! :D</p></blockquote><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-buffer-underflow.png><img class=img src=/images/microcorruption/jakarta/jakarta-buffer-underflow.png alt></a></p><ul><li>Call to <code>strcpy()</code>. The password input copied to <code>0x3ff2 + length of username input</code>.</li><li>Another length check is done. This once checks the total length of username + the password inputs. Address to the copied content is passed for a call to <code>test_username_and_password_valid</code>.</li><li>A byte set at <code>r15</code> is checked if zero and this determines the call to <code>unlock_door</code>.</li></ul><p>Time to get down and dirty!</p><p>You run a test input with the maximum username input and follow the progression:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-max-user.png><img class=img src=/images/microcorruption/jakarta/jakarta-max-user.png alt></a></p><p>This will cause an underflow as you observed earlier;</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-passlen.png><img class=img src=/images/microcorruption/jakarta/jakarta-passlen.png alt></a></p><p>Sweet! You can now have long password input. However, there is still a barrier that you need to bypass: the <code>cmp.b #0x21, r15</code>. The total length of username + password is checked to ensure it is not more than <code>0x21</code>.</p><blockquote><p>Looking at <code>cmp.b</code> instruction from the <a href=https://www.ti.com/lit/ug/slau049f/slau049f.pdf target=_blank>user guide</a>: this operation compares the last <strong>byte</strong> of the source operand from the destination operand.</p></blockquote><p>You just need to ensure that the last byte of <code>r15</code>(the total length of user + pass) is less than <code>0x21</code>. The minimum value for this would be <code>0x100(256)</code> chars. Since the username length is already <code>0x20</code>, the password length needs to be <code>0x100 - 0x20 = 0xe0(224) characters</code>.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-pass.png><img class=img src=/images/microcorruption/jakarta/jakarta-pass.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-jnc.png><img class=img src=/images/microcorruption/jakarta/jakarta-jnc.png alt></a></p><p>Authentication fails as expected(this was a test run). You notice though, that the return address is now overwritten by the copied content.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-sp-overwrite.png><img class=img src=/images/microcorruption/jakarta/jakarta-sp-overwrite.png alt></a></p><p>Can almost see the victory now&mldr;</p><p>You need to modify the 5th and 6th byte of the password input to the call to <code>unlock_door</code> address at <code>0x461c</code>. You try a 32 char username input and this password input:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/jakarta/jakarta-corr-input.png><img class=img src=/images/microcorruption/jakarta/jakarta-corr-input.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/door-unlocked.png><img class=img src=/images/microcorruption/door-unlocked.png alt></a></p><blockquote><p>You cracked it! :D</p><p>Santa Cruz is your oyster now.</p></blockquote></article><section class=article-labels><a class="article-category li" href=/categories/reverse-engineering/><span class=hashtag>#</span>Reverse Engineering</a><a class="article-category li" href=/categories/micro-corruption/><span class=hashtag>#</span>Micro Corruption</a><a class="article-tag li" href=/tags/buffer-underflow/><span class=hashtag>#</span>buffer underflow</a></section><section class=article-navigation><p><a class=link href=/posts/snap_travis/><span class=li></span>Snappy on Travis</a></p><p><a class=link href=/posts/microcorruption-cruz/><span class=li></span>MicroCorruption: Santa Cruz</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>Â© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>