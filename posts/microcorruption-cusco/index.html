<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.118.2"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>MicroCorruption: Cusco&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>MicroCorruption: Cusco</h1><p class=article-date>2020-08-26</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco.jpg><img class=img src=/images/microcorruption/cusco/cusco.jpg alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-details.png><img class=img src=/images/microcorruption/cusco/cusco-details.png alt></a></p><p>In this manual, you notice that:</p><ul><li>This lock is attached to <strong>HSM-1</strong> module.</li><li>The <strong>conditional flag</strong> that accidentally gets set when very long passwords are put in, has been <strong>removed</strong>.</li></ul><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-test-inpput.png><img class=img src=/images/microcorruption/cusco/cusco-test-inpput.png alt></a></p><p>After a <em>fast fail</em> using a test input: <code>aaaaaaaaaaaaaaaa</code>, turns out the program does not exit. It instead, loops back to the start of the program.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-loop-second-login.png><img class=img src=/images/microcorruption/cusco/cusco-loop-second-login.png alt></a></p><p>This is interesting. Why? Because it is a <strong>clue</strong> that at some point at the end of a failed password verification; instead of a program exit, the return address points to the beginning instruction to jump to. This shall become clear soon.</p><p>You do a slow step through the program. The <code>main</code> function just calls the <code>login</code> function.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-login.png><img class=img src=/images/microcorruption/cusco/cusco-login.png alt></a></p><ul><li>Written in the prompt display, passwords required to be <code>8 -16</code> characters.</li><li>the <code>getsn</code> function takes two params:</li></ul><pre tabindex=0><code>// length limits input buffer length
void gets(char *buf, unsigned int length)
</code></pre><blockquote><p><code>r15</code> holds the address that points to the input buffer(where the input would be stored) = <code>sp</code>.</p><p><code>r14</code> holds the input length <code>0x30</code>. This is 48; which is waay more than the specified range limit of <code>8 - 16 bytes</code>. This definitely smells like an <strong>exploitable clue</strong> :)</p></blockquote><ul><li><code>test_valid_password</code> gets called after input. This function basically, makes a call to <code>INT 0x7D</code> to test password validity and sets flag value.</li></ul><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-flag-zero.png><img class=img src=/images/microcorruption/cusco/cusco-flag-zero.png alt></a></p><p>With the input you used, the password validation fails. Observe.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-pc-loop.png><img class=img src=/images/microcorruption/cusco/cusco-pc-loop.png alt></a></p><p>:D&mldr; :D</p><p>The return address is in the value of the next bytes after a <code>16 byte</code> input; which with the initial clue of input length, can be <strong>overwritten</strong>. Another input test can be done.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-extra-bytes.png><img class=img src=/images/microcorruption/cusco/cusco-extra-bytes.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-point-to-input.png><img class=img src=/images/microcorruption/cusco/cusco-point-to-input.png alt></a></p><p>The return address now gets set to <code>6161</code>(<code>aa</code> &lt;- <code>17-18th</code> input bytes). This time the program exits because <code>0x6161</code> is an invalid address.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-pc.png><img class=img src=/images/microcorruption/cusco/cusco-pc.png alt></a></p><p>Now that this is known, what needs to be done is to manipulate the <code>17 -18th</code> input bytes; so that <code>PC</code> gets loaded with a valid address that will jump to where you want it: <code>call to unlock_door</code>.
Following through the <code>login</code> function code, this call to <code>unlock_door</code> is at address <code>0x4528</code>. What&rsquo;s next?</p><blockquote><p>Note on endianness. This processor uses <code>little endian</code> byte ordering.</p></blockquote><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/cusco/cusco-correct-input.png><img class=img src=/images/microcorruption/cusco/cusco-correct-input.png alt></a></p><p>Aaaand..</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/door-unlocked.png><img class=img src=/images/microcorruption/door-unlocked.png alt></a></p><p>Unlocked and unloaded!!</p></article><section class=article-labels><a class="article-category li" href=/categories/reverse-engineering/><span class=hashtag>#</span>Reverse Engineering</a><a class="article-category li" href=/categories/micro-corruption/><span class=hashtag>#</span>Micro Corruption</a><a class="article-tag li" href=/tags/buffer-overflow/><span class=hashtag>#</span>buffer overflow</a></section><section class=article-navigation><p><a class=link href=/posts/microcorruption-whitehorse/><span class=li></span>MicroCorruption: Whitehorse</a></p><p><a class=link href=/posts/microcorruption-hanoi/><span class=li></span>MicroCorruption: Hanoi</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>Â© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>