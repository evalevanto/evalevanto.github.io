<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.120.4"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>SHCTF23: SecureNotes3&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>SHCTF23: SecureNotes3</h1><p class=article-date>2023-09-25</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/notes/00.png><img class=img src=/images/notes/00.png alt=Untitled></a></p><hr><p>You are presented with an apk file: <code>SecureNotes3.apk</code></p><p>The first thing to do is to <a href=http://www.javadecompilers.com/apk target=_blank>decompile the apk</a> to retrieve the java classes and resources.</p><h2 id=code-analysis>Code Analysis</h2><h3 id=mainactivityjava><code>**MainActivity.java**</code></h3><p>The layout has a prompt for a user to input a password. This password is then validated by a function <code>validatePassword</code> from a loaded <code>SecureNotes3.so</code> library. Upon validation, this password is used to decrypt an SQLite DB called <code>notes.db</code> that has a very fishy <code>secrets</code> table.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClick</span><span class=p>(</span><span class=n>DialogInterface</span><span class=w> </span><span class=n>dialogInterface</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>i</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>String</span><span class=w> </span><span class=n>obj</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>editText</span><span class=p>.</span><span class=na>getText</span><span class=p>().</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>validatePassword</span><span class=p>(</span><span class=n>obj</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Toast</span><span class=p>.</span><span class=na>makeText</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>,</span><span class=w> </span><span class=s>&#34;Password Valid!&#34;</span><span class=p>,</span><span class=w> </span><span class=n>0</span><span class=p>).</span><span class=na>show</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>notes</span><span class=p>.</span><span class=na>clear</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>ArrayList</span><span class=w> </span><span class=n>arrayList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>InitializeSQLCipher</span><span class=p>(</span><span class=n>obj</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=n>Cursor</span><span class=w> </span><span class=n>rawQuery</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MainActivity</span><span class=p>.</span><span class=na>this</span><span class=p>.</span><span class=na>f171db</span><span class=p>.</span><span class=na>rawQuery</span><span class=p>(</span><span class=s>&#34;SELECT * FROM secrets;&#34;</span><span class=p>,</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Object</span><span class=o>[</span><span class=n>0</span><span class=o>]</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>rawQuery</span><span class=p>.</span><span class=na>getCount</span><span class=p>()</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=n>0</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>rawQuery</span><span class=p>.</span><span class=na>moveToFirst</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=k>do</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                            </span><span class=n>arrayList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>Note</span><span class=p>(</span><span class=n>rawQuery</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=n>rawQuery</span><span class=p>.</span><span class=na>getColumnIndex</span><span class=p>(</span><span class=s>&#34;title&#34;</span><span class=p>)),</span><span class=w> </span><span class=n>rawQuery</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=n>rawQuery</span><span class=p>.</span><span class=na>getColumnIndex</span><span class=p>(</span><span class=s>&#34;body&#34;</span><span class=p>))));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=p>}</span><span class=w> </span><span class=k>while</span><span class=w> </span><span class=p>(</span><span class=n>rawQuery</span><span class=p>.</span><span class=na>moveToNext</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                        </span><span class=n>Log</span><span class=p>.</span><span class=na>d</span><span class=p>(</span><span class=n>MainActivity</span><span class=p>.</span><span class=na>TAG</span><span class=p>,</span><span class=w> </span><span class=s>&#34;onClick: fetchData in db: No data found in database&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=disassembly><strong>Disassembly</strong></h3><p>You need to reverse engineer the native library file(implemented and compiled by NDK) to understand how the password validation happens.</p><p>Resources:</p><ul><li><a href="https://developer.android.com/ndk/guides?hl=fr" target=_blank>Understanding NDK</a></li><li><a href=https://developer.android.com/training/articles/perf-jni target=_blank>JNI tips</a></li><li><a href=https://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/functions.html target=_blank>JNI functions</a></li></ul><aside>ðŸ’¡ Thanks to Maddie Stoneâ€™s wonderful blog: [https://www.ragingrock.com/AndroidAppRE/reversing_native_libs.html](https://www.ragingrock.com/AndroidAppRE/reversing_native_libs.html)</aside><p>To prepare your Ghidra to begin the disassembly process, you need to load JNI types to resolve JNI symbols. <a href=https://github.com/Ayrx/JNIAnalyzer/blob/master/JNIAnalyzer/data/jni_all.gdt target=_blank>Check out this repo</a>.</p><p>Retype the first parameter of the <code>validatePassword</code> function to <code>JNIEnv</code>:</p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/1.png><img class=img src=/images/notes/1.png alt=Untitled></a></p><p><strong>Function Flow</strong></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/2.png><img class=img src=/images/notes/2.png alt=Untitled></a></p><p><strong>Regex</strong>: The user password should match the following regex string:</p><p><code>([a-z]{2}[0-9])((_[a-z0-9]{5}){2})(_[a-z][0-9])(_[a-z]{3})</code> â†’ <code>ab1_c2d3e_f4g5h_i6_jkl</code></p><p>This means the user password must be 22 bytes.</p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/3.png><img class=img src=/images/notes/3.png alt=Untitled></a></p><p>The userâ€™s input is split by _ .</p><p><strong>The first check</strong></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/4.png><img class=img src=/images/notes/4.png alt=Untitled></a></p><p><strong>The second check</strong></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/5.png><img class=img src=/images/notes/5.png alt=Untitled></a></p><p><strong>The third check</strong></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/6.png><img class=img src=/images/notes/6.png alt=Untitled></a></p><p><strong>The fourth check</strong></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/7.png><img class=img src=/images/notes/7.png alt=Untitled></a></p><p><strong>The last check</strong></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/8.png><img class=img src=/images/notes/8.png alt=Untitled></a></p><p>The final password, following the regex rules:</p><p><code>jn1_stuff_m4k3s_m3_cry</code></p><h2 id=database-decryption>Database decryption</h2><p>You found the database encryption key ðŸŽ‰. Open sesame!</p><aside>ðŸ’¡ Aside: I had trouble using `sqlcipher` to decrypt this database. (Even with changing cipher_compatibility)<p><a target=_blank rel="noopener noreferrer" href=/images/notes/9.png><img class=img src=/images/notes/9.png alt=Untitled></a></p></aside><p><a target=_blank rel="noopener noreferrer" href=/images/notes/10.png><img class=img src=/images/notes/10.png alt=Untitled></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/notes/11.png><img class=img src=/images/notes/11.png alt=Untitled></a></p><p><code>shctf{wh3r3v3r_y0u_4r3_1_w1ll_f1nd_y0u}</code></p></article><section class=article-labels><a class="article-category li" href=/categories/ctf-writeups/><span class=hashtag>#</span>CTF WriteUps</a><a class="article-tag li" href=/tags/shctf/><span class=hashtag>#</span>shctf</a></section><section class=article-navigation><p><a class=link href=/posts/magic_trick/><span class=li></span>SHCTF23: Magic Trick</a></p><p><a class=link href=/posts/veiled_dimensions/><span class=li></span>SHCTF23: Veiled Dimensions</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>Â© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>