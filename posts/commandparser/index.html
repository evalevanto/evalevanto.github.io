<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.114.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>AH19CTF WriteUps: Command Parser&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>AH19CTF WriteUps: Command Parser</h1><p class=article-date>2019-08-17</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/commandparser.png><img class=img src=/images/commandparser.png alt></a></p><h4 id=whats-provided>What&rsquo;s provided:</h4><ul><li>Server access to a directory containing an executable and a flag file.</li></ul><p><a target=_blank rel="noopener noreferrer" href=/images/server_view.png><img class=img src=/images/server_view.png alt></a></p><blockquote><p>You cannot just <code>cat flag</code> because <code>r--r----- 1 commandparserctf-pwn root ... flag</code>
and of course, your <code>whoami</code> profile is not in the sudoers list.</p></blockquote><ul><li>A link to download the executable file.</li></ul><blockquote><p>This is good. You can dissassemble it later.</p></blockquote><h4 id=lets-get-cracking-d>Let&rsquo;s get cracking :D</h4><p>Your first step is to run the executable and have a clue of what it does. Notice the file permissions on the commandparser file above <code>-rwsr-xr-x</code>: the setuid flag <code>s</code>. This means that the file runs with escalated priviledge, in this case, the root(owner of the file). The program asks for an input that is a command to execute. You put in <code>/bin/cat flag</code>; perhaps being run in UID root, this might spit back the flag. You get a <code>input not allowed</code> error instead and the program exits.</p><p>You run <a href=http://man7.org/linux/man-pages/man1/ltrace.1.html target=_blank>ltrace</a>. It will help in debugging. You need to monitor library and system calls made by the process as it executes.</p><p><a target=_blank rel="noopener noreferrer" href=/images/first_try.png><img class=img src=/images/first_try.png alt></a></p><h4 id=findings>Findings:</h4><p>After this we know the input is checked if it contains a certain string <em>bin</em> by the <code>strstr(const char *haystack, const char *needle)</code>call.</p><blockquote><p>Curious about why the program fails and exits yet the <code>strstr</code> clearly returned a True. :nerd_face: :neckbeard:</p></blockquote><p>You decide to test with another input message and see.</p><p><a target=_blank rel="noopener noreferrer" href=/images/second.png><img class=img src=/images/second.png alt></a></p><h4 id=findings2>Findings.2:</h4><p>Interesting!!</p><ul><li>The call to <code>strstr()</code> is made thrice to check for the specific command words <code>bin</code>, <code>cat</code> and <code>flag</code>. Execution continues on fail of these three.</li><li>The length of your input string is determined. <code>strlen()</code></li></ul><blockquote><p>No apparent use for it can be figured from the trace. A note is kept on that though.</p></blockquote><ul><li>Your input is being compared if it matches the string <em>/bin/cat flag</em>!! Yet from the <code>strstr</code> observation, it shouldn&rsquo;t exist in your input.. :confused:</li><li>We can infer that if the <code>strncmp()</code> passes, the <em>/bin/cat flag</em> gets executed somehow.</li></ul><h4 id=on-to-dissassembly>On to dissassembly:</h4><p>You fire up IDA Pro and dissassemble this binary. (Dissassembly can be discussed in detail in a later article :).</p><p><a target=_blank rel="noopener noreferrer" href=/images/functions.png><img class=img src=/images/functions.png alt></a></p><p>These are the functions defined in the program.</p><p><a target=_blank rel="noopener noreferrer" href=/images/main.png><img class=img src=/images/main.png alt></a></p><p>The main function is just as you thought:</p><pre><code>print &quot;Command to execute: &quot;
fgets() get user input. Save that in var_C dword.
if any of the strstr(var_C, str) functions returns a pointer: 
	print out an error statement then exit.
else:
	print &quot;Almost there&quot; then go to pass var_C and var_10 to subroutine at sub_804858B
</code></pre><p>at sub_804858B:</p><p><a target=_blank rel="noopener noreferrer" href=/images/sub.png><img class=img src=/images/sub.png alt></a></p><blockquote><p>arg_0 is our input string. var_14 is the length. var_10 is the counter. arg_4 and var_C are empty strings.</p></blockquote><pre><code>var_14 = strlen(arg_0)

func loc_80485DF: 

	while (var_10 &lt; var_14):
		if (var_10 == 3):
			var_C += get arg_0[var_10] 
</code></pre><blockquote><p>The program returns var_C. Sweet!<br>In simple terms, if<br>arg_0 = &ldquo;aaaabaaaiaaan&rdquo;<br>then var_C = sub_804858B(arg_0)</p><p>var_C = bin :boom:</p></blockquote><p>This string is then sent to <code>strncmp</code> with &ldquo;/bin/cat flag&rdquo;. If this passes, a <code>system</code> call is made with the input string. This will spit the flag! :laughing:</p><h4 id=wrapping-this-up>Wrapping this up:</h4><p>You try the string &ldquo;aaaa/aaabaaaiaaanaaa/aaacaaaaaaataaa aaafaaalaaaaaaag&rdquo; on the execution. (This time without ltrace)</p><p><a target=_blank rel="noopener noreferrer" href=/images/flag.png><img class=img src=/images/flag.png alt></a></p><p>There is your flag: <code>AH{1 533 Y0U 4r3 c001 w1th 5tr1ng5 !!}</code> :boom:.</p><p>The first of many posts.. you hope :)</p></article><section class=article-labels><a class="article-category li" href=/categories/ctf-writeups/><span class=hashtag>#</span>CTF WriteUps</a><a class="article-category li" href=/categories/reverse-engineering/><span class=hashtag>#</span>Reverse Engineering</a><a class="article-tag li" href=/tags/strstr/><span class=hashtag>#</span>strstr</a><a class="article-tag li" href=/tags/ahctf/><span class=hashtag>#</span>ahctf</a></section><section class=article-navigation><p><a class=link href=/posts/gdal/><span class=li></span>GDAL on Travis</a></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>Â© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>