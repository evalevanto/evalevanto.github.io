<!doctype html><html><meta charset=utf-8><meta name=generator content="Hugo 0.114.1"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=color-scheme content="light dark"><meta name=supported-color-schemes content="light dark"><title>MicroCorruption: Montevideo&nbsp;&ndash;&nbsp;The Mess Of Nebula</title><link rel=stylesheet href=/css/core.min.3dff9636f60da21a7bce297e09d08d8f636d1b8e7def5079c790207b0c0dfdc945858b105a0c7fc6c4a0b4f9ae05e8d3.css integrity=sha384-Pf+WNvYNohp7zil+CdCNj2NtG45971B5x5AgewwN/clFhYsQWgx/xsSgtPmuBejT><body><div class="base-body max-width"><section id=header class="header max-body-width"><div class=header-wrap><div class=header-left-side><a class=home href=/><span class=site-name>The Mess Of Nebula</span><span class=site-slogan>Gravitations towards point origin</span></a></div><div class=header-right-side><div class=nav-wrap><div class=nav><a class=site-tag href=/categories/>Categories</a><a class=site-tag href=/tags/>Tags</a><a class=site-tag href=/about>About</a></div></div></div></div></section><div id=content class="flex-body max-body-width"><section class=article-header><h1>MicroCorruption: Montevideo</h1><p class=article-date>2020-09-01</p></section><article class=markdown-body><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte.png><img class=img src=/images/microcorruption/montevideo/monte.png alt></a></p><p>You find a manual:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-dets.png><img class=img src=/images/microcorruption/montevideo/monte-dets.png alt></a></p><ul><li>This lock is <strong>attached to HSM-2 module</strong>. This means, no unlock door function in the lock firmware. This reminds you of a while back in <a href=https://evalevanto.github.io/blog/microcorruption-whitehorse target=_blank><em>WhiteHorse</em></a>.</li><li>The code follows <strong>internal secure development process</strong>. mmh.</li></ul><p>The <code>main</code> function just calls <code>login</code>.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-login.png><img class=img src=/images/microcorruption/montevideo/monte-login.png alt></a></p><ul><li><p>The prompt states for an input range of <code>8 - 16</code> characters. However, from the input to <code>getsn</code> function:</p><ul><li><code>r14</code>: this holds the length of the input buffer; <code>0x30(48)</code> characters. <strong>Clue #1</strong></li><li><code>r15</code>: this holds the address to the input buffer; <code>#0x2400</code>.</li></ul></li><li><p>The input is copied to an address. This is what is new from the Whitehorse challenge and you put a note here:</p></li></ul><blockquote><p>NB:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-strcpy.jpg><img class=img src=/images/microcorruption/montevideo/monte-strcpy.jpg alt></a></p><p><code>strcpy</code> function operates on null-ended strings. What this means is that whenever it encounters a null in a string, this marks the end of the string. It copies until there.</p><p>Note to self: <strong>Do not use null bytes in the middle of the input here!</strong></p></blockquote><ul><li><code>memset</code> function is called. From the parameters pass into it, you can tell the input(at <code>#0x2400</code>) is being replaced by zeros(cleared). There is a hunch here that clearing the input is to prevent things like jumping to instructions injected at the input that might not pass through <code>strcpy</code>. It shall become clear soon.</li><li>The copied input is then passed to <code>conditional_door_unlock</code> function. This function calls an interrupt <code>INT 7E</code> that handles the validation of the password and unlocking of the door.</li><li>Notice the return address is the value in the address <code>add 0x10, sp</code>. <strong>Clue #2</strong></li></ul><p>A look at the <code>conditional_door_unlock</code> function:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-conditional.png><img class=img src=/images/microcorruption/montevideo/monte-conditional.png alt></a></p><p>You do a quick run with a test input <code>aaaaaaaaaaaaaaaaaa</code> of 18 characters. This is observed:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-jump.png><img class=img src=/images/microcorruption/montevideo/monte-jump.png alt></a></p><ul><li>The <code>17th -18th</code> bytes of the input overflow into <code>SP</code>. The return address is in these bytes. You can now jump to another address and execute instructions at that address. You know what this means.. can be <strong>shellcoded</strong>!</li></ul><p>You would want to jump to the beginning of the injected shellcode.</p><p>From the <a href=https://microcorruption.com/manual.pdf target=_blank>manual</a>, <code>INT7F</code> actually triggers the unlock. If this is pushed instead of <code>7E</code> and an interrupt is called, the door should unlock.</p><p><strong>Payload final draft #1</strong>:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-payload-1.png><img class=img src=/images/microcorruption/montevideo/monte-payload-1.png alt></a></p><p>Null byte.. big no no. Want to see it?</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-test-input-2.png><img class=img src=/images/microcorruption/montevideo/monte-test-input-2.png alt></a></p><p>Because of the null byte, the copy will be unfinished therefore the payload incomplete thus plan fails.</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-null.png><img class=img src=/images/microcorruption/montevideo/monte-null.png alt></a></p><blockquote><p>Why not remove the null byte? Why is it there anyway? Answer: The lock&rsquo;s microprocessor(MPS430) has a mandatory memory alignment of 2-bytes. This means instructions, values etc, have to follow this alignment. Therefore, <code>0x7f</code> has to be written as <code>#0x007f</code>. Also, because the microprocessor follows little-endian ordering, thus, <code>#0x007f</code> is eventually inputted as <code>#0x7f00</code>.</p><p>Read more <a href=https://en.wikipedia.org/wiki/Data_structure_alignment target=_blank>here</a>.</p></blockquote><p>The null has to be done away with, but hooow? You need to find a way to push <code>0x007f</code>without there being a null byte in the payload? We can <strong>calculate</strong> it.</p><p>Find two numbers whose addition/subtraction results in <code>#0x007f</code>. You decide to use <code>0x0212</code> and <code>0x0193</code>. Substracting the latter from the former results in <code>0x7f</code>. Sweet!</p><p>Now to assemble the payload.</p><p><strong>Payload final final draft</strong>:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-ass.png><img class=img src=/images/microcorruption/montevideo/monte-ass.png alt></a></p><p>This should work. You input:</p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/montevideo/monte-corr-input.png><img class=img src=/images/microcorruption/montevideo/monte-corr-input.png alt></a></p><p><a target=_blank rel="noopener noreferrer" href=/images/microcorruption/door-unlocked.png><img class=img src=/images/microcorruption/door-unlocked.png alt></a></p><p>and the door opens for you!</p><blockquote><p>Onwards to Novosibirsk..</p></blockquote></article><section class=article-labels><a class="article-category li" href=/categories/reverse-engineering/><span class=hashtag>#</span>Reverse Engineering</a><a class="article-category li" href=/categories/micro-corruption/><span class=hashtag>#</span>Micro Corruption</a><a class="article-tag li" href=/tags/return-address-overwrite/><span class=hashtag>#</span>return address overwrite</a></section><section class=article-navigation><p><a class=link href=/posts/microcorruption-jo/><span class=li></span>MicroCorruption: Johannesburg</a></p><p><a class=link href=/posts/microcorruption-reykjavik/><span class=li></span>MicroCorruption: Reykjavik</a class="link"></p></section><section class=article-discussion><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//the-mess-of-nebula.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></section></div><section id=footer class="footer max-body-width"><p>Â© 2023 Eva Levanto</p><p><span>Powered by </span><a href=https://gohugo.io>Hugo</a><span> and the </span><a href=https://themes.gohugo.io/hugo-notepadium/>Notepadium</a></p></section><script defer type=text/javascript src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-AMS-MML_HTMLorMML" integrity=sha384-e/4/LvThKH1gwzXhdbY2AsjR3rm7LHWyhIG5C0jiRfn8AN2eTN5ILeztWw0H9jmN crossorigin=anonymous>MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"}),MathJax.Hub.Config({TeX:{equationNumbers:{autoNumber:"AMS"}}})</script><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","your-google-analytics-id","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></body></html>